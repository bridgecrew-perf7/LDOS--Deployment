- hosts: "{{ groups['kube-node'] }}"
  name: Configure Nodes
  become: true
  become_method: sudo
  become_user: root
  gather_facts: true
  any_errors_fatal: true
  # selinux must be forced to Python2 it doe snot work in Python3
  vars:
    ansible_python_interpreter: /usr/bin/python

  tasks:
   
    - name: Ping
      ping:
      tags: info

    - name: Install libselinux-python
      package:
        name: libselinux-python
        state: present
      tags: ['selinux']

    - name: Disable SELINUX
      selinux:
        state: disabled
      register: selinux_status
      tags: ['selinux']
     
    - name: Check SELINUX Reboot Status
      debug:  
        msg:
        - "Status= => {{ selinux_status.state }}"
        - "Reboot? => {{ selinux_status.reboot_required }}"
      tags: ['selinux']
 
    - name: Get /etc/dhcp/dhcpclient.conf
      shell: cat /etc/dhcp/dhclient.conf | grep domain-name-servers
      ignore_errors: true
      register: dhcp_nameserver_entry

    # This file will rebuild the /etc/resolv.conf file on reboot.   
    # We need to leverage the private DNS lookup of AWS and not Hitachi Coporate DNS
    - name: Override Hitachi DNS entries
      shell: |
        cp /etc/dhcp/dhclient.conf /etc/dhcp/dhclient.conf.{{ 10000 | random }}.bak
        echo "supersede domain-name-servers {{ dns_server }};" >> /etc/dhcp/dhclient.conf
      register: dhcp_update       
      when: change_dns and ("dhcp_nameserver_entry is not defined" or "'{{ dns_server }}' not in dhcp_nameserver_entry.stdout")

    - name: reboot the machine with all defaults
      reboot:
      when: selinux_status.reboot_required == true or dhcp_update is defined
      tags: ['selinux']
